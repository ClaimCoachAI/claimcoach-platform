# Legal Review Owner Pitch ‚Äî Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace the token-gated legal escalation system with a copy/paste "Owner Escalation Pitch" generated by the PM Brain when status is `LEGAL_REVIEW`.

**Architecture:** Delete `legal_package_service.go` + handler entirely. Add `GenerateOwnerPitch` method to `AuditService` (same pattern as `GenerateDisputeLetter`). Store pitch in `audit_reports.owner_pitch`. The LEGAL_REVIEW panel becomes a 3-phase state machine: generate ‚Üí copy+acknowledge ‚Üí complete step.

**Tech Stack:** Go (gin, database/sql), PostgreSQL migrations, React + TanStack Query, TypeScript

---

### Task 1: Create DB Migration Files

**Files:**
- Create: `backend/internal/database/migrations/000016_add_owner_pitch.up.sql`
- Create: `backend/internal/database/migrations/000016_add_owner_pitch.down.sql`

**Step 1: Create the UP migration**

```sql
-- 000016_add_owner_pitch.up.sql
ALTER TABLE audit_reports ADD COLUMN owner_pitch TEXT;

ALTER TABLE claims DROP COLUMN IF EXISTS legal_partner_name;
ALTER TABLE claims DROP COLUMN IF EXISTS legal_partner_email;
ALTER TABLE claims DROP COLUMN IF EXISTS owner_email;
ALTER TABLE claims DROP COLUMN IF EXISTS legal_escalation_status;

DROP TABLE IF EXISTS legal_approval_requests;
```

**Step 2: Create the DOWN migration**

```sql
-- 000016_add_owner_pitch.down.sql
ALTER TABLE audit_reports DROP COLUMN IF EXISTS owner_pitch;

ALTER TABLE claims ADD COLUMN IF NOT EXISTS legal_escalation_status VARCHAR(50) CHECK (legal_escalation_status IN ('pending_approval', 'approved', 'declined', 'sent_to_lawyer'));
ALTER TABLE claims ADD COLUMN IF NOT EXISTS owner_email VARCHAR(255);
ALTER TABLE claims ADD COLUMN IF NOT EXISTS legal_partner_email VARCHAR(255);
ALTER TABLE claims ADD COLUMN IF NOT EXISTS legal_partner_name VARCHAR(255);

CREATE TABLE IF NOT EXISTS legal_approval_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    claim_id UUID NOT NULL REFERENCES claims(id) ON DELETE CASCADE,
    token VARCHAR(255) NOT NULL UNIQUE,
    owner_name VARCHAR(255) NOT NULL,
    owner_email VARCHAR(255) NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'approved', 'declined', 'expired')),
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    responded_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_legal_approval_token ON legal_approval_requests(token);
CREATE INDEX IF NOT EXISTS idx_legal_approval_claim ON legal_approval_requests(claim_id);
CREATE INDEX IF NOT EXISTS idx_legal_approval_status ON legal_approval_requests(status);
```

**Step 3: Commit**

```bash
git add backend/internal/database/migrations/000016_add_owner_pitch.up.sql
git add backend/internal/database/migrations/000016_add_owner_pitch.down.sql
git commit -m "feat(db): add owner_pitch column, remove legal escalation schema"
```

---

### Task 2: Delete Legal Package Backend Files

**Files:**
- Delete: `backend/internal/services/legal_package_service.go`
- Delete: `backend/internal/handlers/legal_package_handler.go`
- Check & delete if exists: `backend/internal/models/legal_approval_request.go`

**Step 1: Delete the files**

```bash
rm "backend/internal/services/legal_package_service.go"
rm "backend/internal/handlers/legal_package_handler.go"
# Check if a model file exists and delete it
ls backend/internal/models/ | grep legal
# If legal_approval_request.go exists:
rm "backend/internal/models/legal_approval_request.go"
```

**Step 2: Verify the build fails cleanly (expected ‚Äî router still references these)**

```bash
cd backend && go build ./... 2>&1 | head -20
```

Expected: errors about `legalPackageService` and `legalPackageHandler` being undefined ‚Äî that's correct, we fix this in Task 3.

---

### Task 3: Update router.go

**Files:**
- Modify: `backend/internal/api/router.go`

Remove all references to the deleted legal package service and handler. Also add the new owner-pitch route.

**Step 1: Remove the legalPackageService instantiation block**

Find and delete this block (around lines 98-101):
```go
legalPackageService := services.NewLegalPackageService(
    db, emailService, storageClient, claimService, auditService, cfg.FrontendURL,
)
legalPackageHandler := handlers.NewLegalPackageHandler(legalPackageService)
```

**Step 2: Remove the public legal approval routes**

Find and delete these two lines (around lines 117-119):
```go
// Public legal approval endpoints (token-gated, no JWT required)
r.GET("/api/legal-approval/:token", legalPackageHandler.GetApprovalPage)
r.POST("/api/legal-approval/:token/respond", legalPackageHandler.RespondToApproval)
```

**Step 3: Remove the protected legal-escalation route**

Find and delete this line (around line 232):
```go
api.POST("/claims/:id/legal-escalation", legalPackageHandler.InitiateEscalation)
```

**Step 4: Add the new owner-pitch route**

In the protected routes section, directly after the dispute-letter route:
```go
api.POST("/claims/:id/audit/:auditId/dispute-letter", auditHandler.GenerateDisputeLetter)
api.POST("/claims/:id/audit/:auditId/owner-pitch", auditHandler.GenerateOwnerPitch)  // ‚Üê ADD THIS
```

**Step 5: Verify build still fails (expected ‚Äî handler interface not yet updated)**

```bash
cd backend && go build ./... 2>&1 | head -20
```

Expected: errors about `GenerateOwnerPitch` not in interface / not defined in service. Fixed in Tasks 4-7.

---

### Task 4: Update AuditReport Model

**Files:**
- Modify: `backend/internal/models/audit_report.go`

**Step 1: Add OwnerPitch field after DisputeLetter**

Find the struct field:
```go
DisputeLetter   *string `json:"dispute_letter" db:"dispute_letter"`
```

Add immediately after:
```go
OwnerPitch      *string `json:"owner_pitch" db:"owner_pitch"`
```

The block should now look like:
```go
PMBrainAnalysis *string `json:"pm_brain_analysis" db:"pm_brain_analysis"`
DisputeLetter   *string `json:"dispute_letter" db:"dispute_letter"`
OwnerPitch      *string `json:"owner_pitch" db:"owner_pitch"`
```

---

### Task 5: Update AuditService SELECT Queries

**Files:**
- Modify: `backend/internal/services/audit_service.go`

Both SELECT queries must include `ar.owner_pitch` and scan it into `report.OwnerPitch`.

**Step 1: Update GetAuditReportByClaimID query**

Find the SELECT that ends with `ar.pm_brain_analysis, ar.dispute_letter`:
```go
SELECT ar.id, ar.claim_id, ar.scope_sheet_id, ar.carrier_estimate_id,
       ar.generated_estimate, ar.comparison_data, ar.total_contractor_estimate,
       ar.total_carrier_estimate, ar.total_delta, ar.status, ar.error_message,
       ar.created_by_user_id, ar.created_at, ar.updated_at, ar.viability_analysis,
       ar.pm_brain_analysis, ar.dispute_letter
```

Replace with:
```go
SELECT ar.id, ar.claim_id, ar.scope_sheet_id, ar.carrier_estimate_id,
       ar.generated_estimate, ar.comparison_data, ar.total_contractor_estimate,
       ar.total_carrier_estimate, ar.total_delta, ar.status, ar.error_message,
       ar.created_by_user_id, ar.created_at, ar.updated_at, ar.viability_analysis,
       ar.pm_brain_analysis, ar.dispute_letter, ar.owner_pitch
```

Find the corresponding `.Scan(` call and add `&report.OwnerPitch` at the end:
```go
&report.ID, &report.ClaimID, &report.ScopeSheetID, &report.CarrierEstimateID,
&report.GeneratedEstimate, &report.ComparisonData, &report.TotalContractorEstimate,
&report.TotalCarrierEstimate, &report.TotalDelta, &report.Status, &report.ErrorMessage,
&report.CreatedByUserID, &report.CreatedAt, &report.UpdatedAt, &report.ViabilityAnalysis,
&report.PMBrainAnalysis, &report.DisputeLetter, &report.OwnerPitch,  // ‚Üê add OwnerPitch
```

**Step 2: Update getAuditReportWithOwnershipCheck query** (same change, second occurrence)

Same SELECT ‚Üí add `ar.owner_pitch`.
Same Scan ‚Üí add `&report.OwnerPitch`.

---

### Task 6: Add GenerateOwnerPitch Service Method

**Files:**
- Modify: `backend/internal/services/audit_service.go`

Add this method at the end of the file, after `GenerateDisputeLetter`:

```go
// GenerateOwnerPitch writes a plain-English email the PM can send to their building
// owner requesting authorization to escalate to legal. Only valid when pm_brain_analysis
// status is LEGAL_REVIEW.
func (s *AuditService) GenerateOwnerPitch(ctx context.Context, auditReportID, userID, orgID string) (string, error) {
	// 1. Fetch audit report with ownership check
	report, err := s.getAuditReportWithOwnershipCheck(ctx, auditReportID, orgID)
	if err != nil {
		return "", err
	}
	if report.PMBrainAnalysis == nil {
		return "", fmt.Errorf("PM Brain analysis must be run first")
	}

	// 2. Parse PM Brain analysis
	var analysis PMBrainAnalysis
	if err := json.Unmarshal([]byte(*report.PMBrainAnalysis), &analysis); err != nil {
		return "", fmt.Errorf("invalid PM Brain analysis data")
	}
	if analysis.Status != "LEGAL_REVIEW" {
		return "", fmt.Errorf("owner pitch only available when status is LEGAL_REVIEW")
	}

	// 3. Fetch claim context (address, carrier, dates, deductible)
	var address, carrierName, lossType string
	var policyNumber, claimNumber *string
	var incidentDate time.Time
	var deductible float64
	err = s.db.QueryRowContext(ctx, `
		SELECT
			p.legal_address,
			ip.carrier_name,
			ip.policy_number,
			c.claim_number,
			c.incident_date,
			ip.deductible_value,
			c.loss_type
		FROM claims c
		INNER JOIN properties p ON c.property_id = p.id
		INNER JOIN insurance_policies ip ON c.policy_id = ip.id
		WHERE c.id = $1
	`, report.ClaimID).Scan(
		&address, &carrierName, &policyNumber, &claimNumber, &incidentDate, &deductible, &lossType,
	)
	if err != nil {
		return "", fmt.Errorf("failed to fetch claim context: %w", err)
	}

	// 4. Build prompt
	var b strings.Builder
	b.WriteString("You are drafting an email for a professional Property Manager to send to their building owner regarding an insurance claim dispute.\n\n")
	b.WriteString("CLAIM CONTEXT:\n")
	b.WriteString(fmt.Sprintf("- Property Address: %s\n", address))
	b.WriteString(fmt.Sprintf("- Loss Type: %s on %s\n", lossType, incidentDate.Format("January 2, 2006")))
	b.WriteString(fmt.Sprintf("- Insurance Carrier: %s\n", carrierName))
	b.WriteString(fmt.Sprintf("- Policy Deductible: $%.2f\n\n", deductible))
	b.WriteString("PM BRAIN ANALYSIS:\n")
	b.WriteString(fmt.Sprintf("- Contractor Estimate: $%.2f\n", analysis.TotalContractorEstimate))
	b.WriteString(fmt.Sprintf("- Carrier Offer: $%.2f\n", analysis.TotalCarrierEstimate))
	b.WriteString(fmt.Sprintf("- Gap (Underpayment): $%.2f\n\n", analysis.TotalDelta))

	if len(analysis.TopDeltaDrivers) > 0 {
		b.WriteString("TOP DELTA DRIVERS:\n")
		for _, d := range analysis.TopDeltaDrivers {
			b.WriteString(fmt.Sprintf("- %s: carrier paid $%.2f vs contractor $%.2f (gap: $%.2f) ‚Äî %s\n",
				d.LineItem, d.CarrierPrice, d.ContractorPrice, d.Delta, d.Reason))
		}
		b.WriteString("\n")
	}

	if len(analysis.CoverageDisputes) > 0 {
		b.WriteString("COVERAGE DISPUTES:\n")
		for _, cd := range analysis.CoverageDisputes {
			b.WriteString(fmt.Sprintf("- %s (%s): %s\n", cd.Item, cd.Status, cd.ContractorPosition))
		}
		b.WriteString("\n")
	}

	b.WriteString(`Write a professional email FROM the Property Manager TO the building owner.

Requirements:
- Open by stating the carrier has made their final offer on the claim
- Explain the dollar gap in plain English ‚Äî why this amount is unacceptable
- Cite 2-3 specific line items or coverage disputes showing why the carrier's offer is unreasonable
- Recommend they authorize engaging a public adjuster or real estate attorney
- Close by asking the owner to reply with their approval to proceed
- Tone: competent, direct, professional ‚Äî like a trusted advisor, NOT a lawyer
- Length: 3-4 short paragraphs, no filler phrases
- Do NOT include a subject line or "Subject:" prefix
- Do NOT use placeholder text like "[Your Name]" ‚Äî write as "your property manager"
- Return ONLY the email body text, no preamble or explanation`)

	// 5. Call LLM
	messages := []llm.Message{
		{
			Role:    "system",
			Content: "You are a professional property manager writing a clear, persuasive email to a building owner about an insurance dispute. Write in first person as the property manager. Return only the email body, no markdown, no preamble.",
		},
		{
			Role:    "user",
			Content: b.String(),
		},
	}

	response, err := s.llmClient.Chat(ctx, messages, 0.4, 1500)
	if err != nil {
		return "", fmt.Errorf("LLM API call failed: %w", err)
	}
	if len(response.Choices) == 0 {
		return "", fmt.Errorf("LLM returned no choices")
	}

	pitchText := response.Choices[0].Message.Content

	// 6. Save to DB
	_, err = s.db.ExecContext(ctx,
		`UPDATE audit_reports SET owner_pitch = $1, updated_at = NOW() WHERE id = $2`,
		pitchText, auditReportID,
	)
	if err != nil {
		return "", fmt.Errorf("failed to save owner pitch: %w", err)
	}

	// 7. Log API usage
	_ = s.logAPIUsage(ctx, orgID, response)

	return pitchText, nil
}
```

---

### Task 7: Update AuditHandler

**Files:**
- Modify: `backend/internal/handlers/audit_handler.go`

**Step 1: Add GenerateOwnerPitch to the interface**

Find `AuditServiceInterface` and add the new method:

```go
type AuditServiceInterface interface {
	GenerateIndustryEstimate(ctx context.Context, claimID, userID, orgID string) (string, error)
	GetAuditReportByClaimID(ctx context.Context, claimID, orgID string) (*models.AuditReport, error)
	AnalyzeClaimViability(ctx context.Context, claimID, orgID string) (*services.ViabilityAnalysis, error)
	RunPMBrainAnalysis(ctx context.Context, auditReportID, userID, orgID string) (*services.PMBrainAnalysis, error)
	GenerateDisputeLetter(ctx context.Context, auditReportID, userID, orgID string) (string, error)
	GenerateOwnerPitch(ctx context.Context, auditReportID, userID, orgID string) (string, error)
}
```

**Step 2: Add the handler method** (after GenerateDisputeLetter)

```go
// GenerateOwnerPitch generates a plain-English escalation pitch email for the building owner.
// POST /api/claims/:id/audit/:auditId/owner-pitch
func (h *AuditHandler) GenerateOwnerPitch(c *gin.Context) {
	user := c.MustGet("user").(models.User)
	auditReportID := c.Param("auditId")

	pitch, err := h.service.GenerateOwnerPitch(c.Request.Context(), auditReportID, user.ID, user.OrganizationID)
	if err != nil {
		if strings.Contains(err.Error(), "audit report not found") {
			c.JSON(http.StatusNotFound, gin.H{"success": false, "error": "Audit report not found"})
			return
		}
		if strings.Contains(err.Error(), "must be run first") || strings.Contains(err.Error(), "only available when") {
			c.JSON(http.StatusBadRequest, gin.H{"success": false, "error": err.Error()})
			return
		}
		c.JSON(http.StatusInternalServerError, gin.H{"success": false, "error": "Failed to generate owner pitch: " + err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"success": true, "data": gin.H{"pitch": pitch}})
}
```

---

### Task 8: Run Migration & Verify Backend Compiles

**Step 1: Run migration**

```bash
cd backend && migrate -path internal/database/migrations -database "$DATABASE_URL" up
```

Or if using the project's migration runner:
```bash
cd backend && go run cmd/migrate/main.go up
```

Expected: Migration 000016 applied successfully.

**Step 2: Verify clean build**

```bash
cd backend && go build ./...
```

Expected: No errors. If there are errors, check:
- `models.LegalApprovalRequest` referenced anywhere ‚Äî delete that model file if it exists
- Any import of `legal_package_service` or `legal_package_handler` packages still present

**Step 3: Commit**

```bash
git add backend/
git commit -m "feat(backend): add GenerateOwnerPitch, remove legal escalation infrastructure"
```

---

### Task 9: Update frontend/src/lib/api.ts

**Files:**
- Modify: `frontend/src/lib/api.ts`

**Step 1: Remove sendLegalEscalation**

Delete this entire function:
```typescript
export const sendLegalEscalation = async (claimId: string, data: {
  legal_partner_name: string
  legal_partner_email: string
  owner_name: string
  owner_email: string
}) => {
  const response = await api.post(`/api/claims/${claimId}/legal-escalation`, data)
  return response.data
}
```

**Step 2: Add generateOwnerPitch** (after generateDisputeLetter)

```typescript
export const generateOwnerPitch = async (claimId: string, auditId: string) => {
  const response = await api.post(`/api/claims/${claimId}/audit/${auditId}/owner-pitch`)
  return response.data.data.pitch as string
}
```

---

### Task 10: Update frontend/src/types/claim.ts

**Files:**
- Modify: `frontend/src/types/claim.ts`

**Step 1: Remove legal escalation fields from Claim interface**

Find and delete these 4 lines from the `Claim` interface:
```typescript
  // Legal escalation (added in migration 000011)
  legal_partner_name?: string
  legal_partner_email?: string
  owner_email?: string
  legal_escalation_status?: 'pending_approval' | 'approved' | 'declined' | 'sent_to_lawyer'
```

The Claim interface should end at `updated_at` after this removal.

---

### Task 11: Update Step6AdjudicationEngine ‚Äî State & Mutations

**Files:**
- Modify: `frontend/src/components/Step6AdjudicationEngine.tsx`

**Step 1: Update imports**

Find the import line that includes `sendLegalEscalation` and replace it with `generateOwnerPitch`:
```typescript
import {
  generateIndustryEstimate,
  runPMBrainAnalysis,
  generateDisputeLetter,
  generateOwnerPitch,       // ‚Üê add
  parseCarrierEstimate,
  updateClaimStep,
  getAuditReport,
  getCarrierEstimates,
} from '../lib/api'
```
(Remove `sendLegalEscalation` from this import ‚Äî exact shape depends on current import style.)

**Step 2: Replace legal state variables with pitch state variables**

Find and delete these state variable declarations:
```typescript
  // Legal escalation
  const [legalPartnerName, setLegalPartnerName] = useState('')
  const [legalPartnerEmail, setLegalPartnerEmail] = useState('')
  const [ownerName, setOwnerName] = useState(
    claim.property?.owner_entity_name || ''
  )
  const [ownerEmail, setOwnerEmail] = useState('')
  const [legalSubmitted, setLegalSubmitted] = useState<{
    partnerName: string
  } | null>(null)
```

Replace with:
```typescript
  // Owner pitch (LEGAL_REVIEW)
  const [ownerPitch, setOwnerPitch] = useState<string | null>(null)
  const [pitchCopied, setPitchCopied] = useState(false)
  const [pitchAcknowledged, setPitchAcknowledged] = useState(false)
```

**Step 3: Update the restore-from-saved useEffect**

Find:
```typescript
      if (savedAuditReport.dispute_letter) setDisputeLetter(savedAuditReport.dispute_letter)
```

Add the line immediately after:
```typescript
      if (savedAuditReport.dispute_letter) setDisputeLetter(savedAuditReport.dispute_letter)
      if (savedAuditReport.owner_pitch) setOwnerPitch(savedAuditReport.owner_pitch)
```

**Step 4: Replace legalMutation with pitchMutation**

Find and delete the entire `legalMutation` block:
```typescript
  // ‚îÄ‚îÄ Legal escalation mutation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const legalMutation = useMutation({
    mutationFn: () =>
      sendLegalEscalation(claim.id, {
        legal_partner_name: legalPartnerName,
        legal_partner_email: legalPartnerEmail,
        owner_name: ownerName,
        owner_email: ownerEmail,
      }),
    onSuccess: () => setLegalSubmitted({ partnerName: legalPartnerName }),
  })
```

Replace with:
```typescript
  // ‚îÄ‚îÄ Owner pitch mutation (LEGAL_REVIEW) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pitchMutation = useMutation({
    mutationFn: async () => {
      const reportId = auditReportId || savedAuditReport?.id
      if (!reportId) throw new Error('No audit report found')
      return generateOwnerPitch(claim.id, reportId)
    },
    onSuccess: (pitch) => {
      setOwnerPitch(pitch)
      queryClient.invalidateQueries({ queryKey: ['audit-report', claim.id] })
    },
    onError: (err: unknown) => {
      const msg = (err as any)?.response?.data?.error || 'Failed to generate pitch. Please try again.'
      setErrorMsg(msg)
    },
  })
```

---

### Task 12: Update Step6AdjudicationEngine ‚Äî LEGAL_REVIEW JSX

**Files:**
- Modify: `frontend/src/components/Step6AdjudicationEngine.tsx`

**Step 1: Replace the entire LEGAL_REVIEW panel**

Find the entire `LEGAL_REVIEW` block (starts with `{/* ‚îÄ‚îÄ LEGAL_REVIEW: escalation form */}` and ends with its closing `)}`) and replace it with the 3-phase state machine:

```tsx
        {/* ‚îÄ‚îÄ LEGAL_REVIEW: owner escalation pitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
        {pmBrain.status === 'LEGAL_REVIEW' && !step6Done && (
          <div>
            {!ownerPitch ? (
              /* Phase 1: Generate pitch */
              <div>
                {pitchMutation.isError && (
                  <div style={{ padding: '10px 14px', background: '#fef2f2', border: '1px solid #fecaca', borderRadius: 8, marginBottom: 12 }}>
                    <span style={{ color: '#991b1b', fontSize: 13 }}>
                      {(pitchMutation.error as any)?.response?.data?.error || 'Failed to generate pitch. Please try again.'}
                    </span>
                  </div>
                )}
                <button
                  onClick={() => pitchMutation.mutate()}
                  disabled={pitchMutation.isPending}
                  style={{
                    width: '100%',
                    padding: '14px 24px',
                    background: '#dc2626',
                    color: '#fff',
                    border: 'none',
                    borderRadius: 8,
                    fontWeight: 700,
                    cursor: pitchMutation.isPending ? 'not-allowed' : 'pointer',
                    fontSize: 15,
                    opacity: pitchMutation.isPending ? 0.7 : 1,
                  }}
                >
                  {pitchMutation.isPending ? 'Generating‚Ä¶' : 'üìã Generate Escalation Pitch'}
                </button>
              </div>
            ) : !pitchAcknowledged ? (
              /* Phase 2: Show pitch + copy + confirm */
              <div>
                <div
                  style={{
                    border: '1px solid #e2e8f0',
                    borderRadius: 10,
                    overflow: 'hidden',
                    marginBottom: 16,
                  }}
                >
                  <div
                    style={{
                      padding: '12px 18px',
                      background: '#f8fafc',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      borderBottom: '1px solid #e2e8f0',
                    }}
                  >
                    <span style={{ fontWeight: 700, color: '#0f172a', fontSize: 14 }}>
                      üìã Owner Escalation Pitch
                    </span>
                    <button
                      onClick={() => {
                        navigator.clipboard.writeText(ownerPitch)
                        setPitchCopied(true)
                        setTimeout(() => setPitchCopied(false), 2000)
                      }}
                      style={{
                        padding: '6px 14px',
                        background: pitchCopied ? '#0d9488' : '#fff',
                        color: pitchCopied ? '#fff' : '#334155',
                        border: '1px solid #e2e8f0',
                        borderRadius: 6,
                        fontSize: 13,
                        cursor: 'pointer',
                        fontWeight: 600,
                      }}
                    >
                      {pitchCopied ? '‚úì Copied' : 'Copy'}
                    </button>
                  </div>
                  <pre
                    style={{
                      margin: 0,
                      padding: '18px 20px',
                      fontFamily: 'Georgia, serif',
                      fontSize: 13,
                      lineHeight: 1.7,
                      color: '#0f172a',
                      whiteSpace: 'pre-wrap',
                      maxHeight: 420,
                      overflowY: 'auto',
                    }}
                  >
                    {ownerPitch}
                  </pre>
                </div>
                <div
                  style={{
                    padding: '14px 18px',
                    background: '#fef9c3',
                    border: '1px solid #fde68a',
                    borderRadius: 8,
                    marginBottom: 12,
                    fontSize: 13,
                    color: '#713f12',
                  }}
                >
                  Copy this pitch and paste it into your email client to send to your property owner.
                  Once you've sent it, click the button below.
                </div>
                <button
                  onClick={() => setPitchAcknowledged(true)}
                  style={{
                    width: '100%',
                    padding: '14px 24px',
                    background: '#1e293b',
                    color: '#fff',
                    border: 'none',
                    borderRadius: 8,
                    fontWeight: 700,
                    cursor: 'pointer',
                    fontSize: 15,
                  }}
                >
                  ‚úì I Have Sent This to the Property Owner
                </button>
              </div>
            ) : (
              /* Phase 3: Acknowledged ‚Äî show complete step */
              <div
                style={{
                  padding: '20px 24px',
                  background: '#f0fdf4',
                  borderRadius: 10,
                  border: '1px solid #bbf7d0',
                  textAlign: 'center',
                }}
              >
                <div style={{ fontSize: 28, marginBottom: 8 }}>‚úÖ</div>
                <div style={{ fontWeight: 700, color: '#166534', fontSize: 16, marginBottom: 4 }}>
                  Owner notified. You've done your part.
                </div>
                <div style={{ color: '#15803d', fontSize: 13, marginBottom: 20 }}>
                  The legal review process can now begin.
                </div>
                {completeMutation.isError && (
                  <div style={{ padding: '8px 12px', background: '#fef2f2', borderRadius: 6, marginBottom: 12 }}>
                    <span style={{ color: '#991b1b', fontSize: 13 }}>Failed to advance. Please try again.</span>
                  </div>
                )}
                <button
                  onClick={() => completeMutation.mutate()}
                  disabled={completeMutation.isPending}
                  style={{
                    width: '100%',
                    padding: '14px 24px',
                    background: '#16a34a',
                    color: '#fff',
                    border: 'none',
                    borderRadius: 8,
                    fontWeight: 700,
                    cursor: completeMutation.isPending ? 'not-allowed' : 'pointer',
                    fontSize: 15,
                    opacity: completeMutation.isPending ? 0.7 : 1,
                  }}
                >
                  {completeMutation.isPending ? 'Saving‚Ä¶' : 'Step Complete ‚Äî Continue to Payments ‚Üí'}
                </button>
              </div>
            )}
          </div>
        )}
```

**Step 2: Verify no remaining references to legalMutation, legalPartnerName, etc.**

```bash
grep -n "legalMutation\|legalPartnerName\|legalPartnerEmail\|legalSubmitted\|sendLegalEscalation\|ownerEmail\|ownerName" \
  "frontend/src/components/Step6AdjudicationEngine.tsx"
```

Expected: No output. If any remain, delete them.

---

### Task 13: Verify TypeScript/Vite Build & Commit

**Step 1: Run TypeScript check**

```bash
cd frontend && npx tsc --noEmit 2>&1
```

Expected: No errors.

**Step 2: Run Vite build**

```bash
cd frontend && npm run build 2>&1 | tail -10
```

Expected: `‚úì built in X.XXs` with no errors.

**Step 3: Commit all frontend changes**

```bash
git add frontend/src/lib/api.ts \
        frontend/src/types/claim.ts \
        frontend/src/components/Step6AdjudicationEngine.tsx
git commit -m "feat(frontend): replace legal escalation form with Owner Escalation Pitch UI"
```
